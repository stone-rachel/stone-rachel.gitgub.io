<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ERB RUNNERS ¬∑ Team Board</title>

  <!-- Pretendard + Poppins -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --text:#101828;
      --sub:#667085;
      --muted:#98a2b3;
      --line: rgba(16,24,40,.08);

      --shadow: 0 10px 30px rgba(16,24,40,.08);
      --shadow2: 0 6px 18px rgba(16,24,40,.06);

      /* top3 */
      --gold:#f6c343;
      --silver:#cfd6e6;
      --bronze:#c97b4a;
      --grayBadge:#94a3b8;

      --blue:#3182f6;
      --blue2:#1d4ed8;

      --radius: 22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Pretendard, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x:hidden;
    }

    /* ===== Running track background ===== */
    .bgTrack{
      position: fixed;
      inset: -140px -180px auto auto;
      width: 760px;
      height: 760px;
      opacity: .10;
      pointer-events:none;
      z-index: 0;
    }
    .bgTrack2{
      position: fixed;
      inset: auto auto -220px -220px;
      width: 860px;
      height: 860px;
      opacity: .08;
      pointer-events:none;
      z-index: 0;
      transform: rotate(12deg);
    }

    .wrap{
      max-width: 780px;
      margin: 0 auto;
      padding: 18px 14px 32px;
      position:relative;
      z-index: 1;
    }

    header{ padding: 10px 2px 14px; }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
      margin-bottom: 12px;
    }
    .logo{
      width:38px; height:38px;
      border-radius: 14px;
      background: linear-gradient(135deg, #3182f6, #a78bfa);
      box-shadow: 0 10px 18px rgba(16,24,40,.14);
      flex: 0 0 auto;
    }
    .brandText{ min-width:0; }
    .brandTitle{
      font-weight: 1000;
      letter-spacing: -0.2px;
      font-size: 14px;
      line-height: 1.15;
    }
    .brandSub{
      display:block;
      margin-top: 2px;
      font-size: 12px;
      color: var(--sub);
      line-height: 1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 460px;
    }

    .hero{
      padding: 16px 18px 16px;
      border-radius: var(--radius);
      background: #fff;
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .hero::before{
      content:"";
      position:absolute;
      inset:-120px -220px auto auto;
      width:520px; height:520px;
      background: radial-gradient(circle at 30% 30%, rgba(49,130,246,.18), transparent 55%),
                  radial-gradient(circle at 70% 60%, rgba(167,139,250,.14), transparent 55%);
      pointer-events:none;
    }

    .heroTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 14px;
      flex-wrap:wrap;
      position:relative;
      z-index:1;
    }

    h1{
      margin:0;
      font-size: 36px;
      line-height: 1.06;
      letter-spacing: -0.8px;
      font-weight: 1000;
    }
    .subtitle{
      margin-top: 6px;
      font-size: 13px;
      color: var(--sub);
      line-height: 1.3;
    }
    .smallLine{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    /* ===== (NEW) Program progress runner bar (FIXED: no clipping) ===== */
    .progWrap{
      margin-bottom: 12px;
      position:relative;
      z-index:1;
    }
    .progTop{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      margin-bottom: 6px;
    }
    .progTitle{
      font-size: 12px;
      font-weight: 1000;
      color: var(--sub);
      letter-spacing: -0.1px;
    }
    .progPct{
      font-family: "Poppins", system-ui, sans-serif;
      font-size: 12px;
      font-weight: 700;
      color: var(--muted);
    }

    .progTrackWrap{
      position: relative;
      padding-top: 22px; /* runner space */
    }
    .progTrack{
      position:relative;
      height: 12px;
      border-radius: 999px;
      background: rgba(16,24,40,.06);
      border: 1px solid rgba(16,24,40,.06);
      overflow: hidden; /* keep fill rounded */
    }
    .progFill{
      position:absolute;
      inset:0 auto 0 0;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(246,195,67,1), rgba(255,79,216,1), rgba(59,130,246,1));
    }

    .runner{
      position:absolute;
      top: 0; /* inside padding area */
      left: 0px; /* px-based move */
      transform: translateX(-50%);
      display:flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(16,24,40,.10);
      box-shadow: 0 10px 18px rgba(16,24,40,.10);
      backdrop-filter: blur(8px);
      white-space:nowrap;
      user-select:none;
      z-index: 2;
    }
    .runnerIcon{ font-size: 14px; line-height: 1; }
    .runnerText{
      font-family: "Poppins", system-ui, sans-serif;
      font-size: 12px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.1px;
    }

    .progMeta{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      margin-top: 6px;
      color: var(--muted);
      font-size: 11px;
      font-family: "Poppins", system-ui, sans-serif;
      font-weight: 600;
    }

    /* ===== Data reflected bar under Week ===== */
    .dataInfo{
      margin-top: 10px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .dataInfoText{
      font-size: 12px;
      color: var(--sub);
      font-weight: 800;
      letter-spacing: -0.1px;
    }
    .dataBar{
      width: 220px;
      height: 8px;
      border-radius: 999px;
      background: rgba(16,24,40,.06);
      overflow:hidden;
      border: 1px solid rgba(16,24,40,.06);
    }
    .dataBarFill{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(246,195,67,1), rgba(255,79,216,1), rgba(59,130,246,1));
    }

    /* ===== Controls ===== */
    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid var(--line);
      box-shadow: var(--shadow2);
    }
    .pill span{
      color: var(--muted);
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .02em;
    }
    input[type="text"]{
      border:none; outline:none;
      background: transparent;
      color: var(--text);
      width: 210px;
      font-size: 14px;
      font-weight: 800;
      font-family: Pretendard, system-ui, sans-serif;
    }
    input[type="text"]::placeholder{ color: #c0c7d2; font-weight: 700; }

    .btn{
      border:none;
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(49,130,246,.10);
      border: 1px solid rgba(49,130,246,.18);
      color: var(--blue2);
      font-weight: 1000;
      font-family: Pretendard, system-ui, sans-serif;
      box-shadow: var(--shadow2);
    }
    .btn:hover{ background: rgba(49,130,246,.14); }

    main{ margin-top: 14px; }
    .sheet{ background: transparent; padding: 0; }

    /* ===== Row Card ===== */
    .row{
      position: relative;
      background: var(--card);
      border-radius: 20px;
      border: 1px solid var(--line);
      box-shadow: var(--shadow2);
      padding: 16px 16px 22px;
      margin: 10px 0;

      display:grid;
      grid-template-columns: 1fr auto;
      gap: 14px;
      overflow:hidden;
    }

    /* colorful top3 highlight line */
    .row.top1::before,
    .row.top2::before,
    .row.top3::before{
      content:"";
      position:absolute;
      left:0; right:0; top:0;
      height: 6px;
    }
    .row.top1::before{ background: linear-gradient(90deg, rgba(246,195,67,.95), rgba(246,195,67,.10)); }
    .row.top2::before{ background: linear-gradient(90deg, rgba(207,214,230,.95), rgba(207,214,230,.12)); }
    .row.top3::before{ background: linear-gradient(90deg, rgba(201,123,74,.95), rgba(201,123,74,.10)); }

    .leftBlock{
      display:flex;
      gap: 12px;
      align-items:flex-start;
      min-width: 0;
    }

    /* Rank badge: top3 colorful + 3D */
    .rankBadge{
      flex: 0 0 auto;
      width: 52px;
      height: 52px;
      border-radius: 16px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 1000;
      font-size: 18px;
      user-select:none;

      background: #eef2f6;
      color: #0b1220;
      border: 1px solid rgba(255,255,255,.9);
      box-shadow: 0 10px 16px rgba(2,6,23,.12);
      position:relative;
    }
    .rankBadge::before,
    .rankBadge::after{
      content:"";
      position:absolute;
      bottom:-15px;
      width: 14px; height: 18px;
      border-radius: 0 0 7px 7px;
      box-shadow: 0 8px 14px rgba(2,6,23,.10);
    }
    .rankBadge::before{ left: 12px; transform: rotate(2deg); }
    .rankBadge::after{ right: 12px; transform: rotate(-2deg); }

    .rankBadge.top3d{
      box-shadow:
        0 16px 22px rgba(2,6,23,.18),
        inset 0 2px 0 rgba(255,255,255,.65),
        inset 0 -4px 10px rgba(2,6,23,.16);
      border: 1px solid rgba(255,255,255,.92);
    }

    .rankBadge.gold{ background: linear-gradient(135deg, var(--gold), rgba(246,195,67,.55)); }
    .rankBadge.silver{ background: linear-gradient(135deg, var(--silver), rgba(207,214,230,.55)); }
    .rankBadge.bronze{ background: linear-gradient(135deg, var(--bronze), rgba(201,123,74,.55)); }
    .rankBadge.gray{ background: linear-gradient(135deg, var(--grayBadge), rgba(148,163,184,.55)); color:#0b1220; }

    .rankBadge.gold::before, .rankBadge.gold::after{ background: rgba(255,79,216,.45); }
    .rankBadge.silver::before, .rankBadge.silver::after{ background: rgba(59,130,246,.34); }
    .rankBadge.bronze::before, .rankBadge.bronze::after{ background: rgba(234,88,12,.26); }
    .rankBadge.gray::before, .rankBadge.gray::after{ background: rgba(37,99,235,.14); }

    .teamBlock{ min-width:0; }

    /* team + members bigger */
    .team{
      font-weight: 1000;
      font-size: 19px;
      letter-spacing: -0.35px;
      line-height: 1.15;
      color: var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 520px;
    }
    .members{
      margin-top: 8px;
      color: var(--sub);
      font-size: 13px;
      line-height: 1.4;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 560px;
      letter-spacing: -0.15px;
    }

    .right{
      text-align:right;
      min-width: 156px;
      font-variant-numeric: tabular-nums;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap: 8px;
    }

    .rightTop{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 8px;
      height: 24px;
    }

    /* Perfect */
    .perfectTag{
      display:inline-block;
      font-family: "Poppins", Pretendard, system-ui, sans-serif;
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .2px;
      line-height: 1;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(16,24,40,.10);
      background: rgba(255,255,255,.72);
      backdrop-filter: blur(8px);

      background-image: linear-gradient(90deg,
        rgba(246,195,67,1) 0%,
        rgba(255,79,216,1) 45%,
        rgba(59,130,246,1) 100%);
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
    }

    .meta{
      display:flex;
      flex-direction:column;
      gap: 4px;
      align-items:flex-end;
    }

    .labels{
      font-family: "Poppins", system-ui, sans-serif;
      color: var(--muted);
      font-size: 11px;
      letter-spacing: .16em;
      user-select:none;
      font-weight: 700;
    }

    .numbersLine{
      font-family: "Poppins", system-ui, sans-serif;
      color: var(--sub);
      font-size: 12px;
      user-select:none;
      font-weight: 600;
      letter-spacing: 0;
      font-variant-numeric: tabular-nums;
      -webkit-font-smoothing: antialiased;
    }

    .total{
      font-family: "Poppins", system-ui, sans-serif;
      font-size: 28px;
      font-weight: 700;
      line-height: 1;
      color: #111827;
      letter-spacing: -0.2px;
      text-rendering: geometricPrecision;
      -webkit-font-smoothing: antialiased;
    }
    .total.rank1{
      color: var(--gold);
      text-shadow: 0 10px 22px rgba(246,195,67,.18);
    }
    .total.rank2{
      color: #9aa6bf;
      text-shadow: 0 10px 22px rgba(158,170,191,.16);
    }
    .total.rank3{
      color: var(--bronze);
      text-shadow: 0 10px 22px rgba(201,123,74,.16);
    }

    /* progress */
    .progressTrack{
      position:absolute;
      left: 16px;
      right: 16px;
      bottom: 10px;
      height: 5px;
      border-radius: 999px;
      background: rgba(16,24,40,.06);
      overflow:hidden;
    }
    .progressFill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(49,130,246,1), rgba(29,78,216,1));
      border-radius: 999px;
    }

    .hint{
      color: var(--sub);
      font-size: 12px;
      margin: 10px 4px 0;
      line-height: 1.45;
    }

    details{
      margin-top: 14px;
      border-radius: var(--radius);
      background: #fff;
      border: 1px solid var(--line);
      padding: 12px 14px;
      color: var(--text);
      box-shadow: var(--shadow2);
    }
    summary{
      cursor:pointer;
      font-weight: 1000;
      color: var(--text);
    }
    textarea{
      width:100%;
      min-height:120px;
      resize:vertical;
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: #fbfcfe;
      color: var(--text);
      padding: 12px;
      outline:none;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }
    .rowSmall{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:10px;
      flex-wrap:wrap;
    }

    @media (max-width:520px){
      input[type="text"]{ width: 160px; }
      h1{ font-size: 32px; }
      .team{ font-size: 18px; max-width: 320px; }
      .members{ font-size: 13px; max-width: 320px; }
      .total{ font-size: 27px; }
      .right{ min-width: 138px; }
      .dataBar{ width: 180px; }
      .progMeta{ font-size: 10px; }
      .progPct{ font-size: 11px; }
    }
  </style>
</head>

<body>
  <!-- Track backgrounds -->
  <svg class="bgTrack" viewBox="0 0 600 600" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <path d="M80 310C140 180 260 120 370 120C520 120 560 230 560 300C560 410 470 490 350 490C220 490 150 420 150 340C150 270 200 240 250 240"
          stroke="rgba(49,130,246,1)" stroke-width="18" stroke-linecap="round"/>
    <path d="M110 330C170 210 285 160 380 160C490 160 520 250 520 300C520 390 450 450 350 450C250 450 200 400 200 340C200 290 240 270 280 270"
          stroke="rgba(167,139,250,1)" stroke-width="10" stroke-linecap="round"/>
    <path d="M145 350C205 245 315 205 395 205C470 205 490 265 490 300C490 365 435 410 350 410C275 410 240 375 240 340C240 310 265 300 300 300"
          stroke="rgba(246,195,67,1)" stroke-width="6" stroke-linecap="round"/>
  </svg>

  <svg class="bgTrack2" viewBox="0 0 600 600" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <path d="M70 320C150 170 290 110 405 120C535 133 575 250 560 325C540 430 445 505 320 500C210 495 140 420 150 345C160 275 230 240 275 240"
          stroke="rgba(16,24,40,1)" stroke-width="16" stroke-linecap="round" opacity=".55"/>
    <path d="M120 350C190 230 310 175 405 185C495 195 520 265 505 320C485 400 420 445 330 445C250 445 205 405 210 350C215 310 250 290 290 290"
          stroke="rgba(49,130,246,1)" stroke-width="8" stroke-linecap="round" opacity=".35"/>
  </svg>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="brandText">
          <div class="brandTitle">ERB RUNNERS</div>
          <small class="brandSub">ÌåÄ ÌòÑÌô© ¬∑ ÏûêÎèô ÏàúÏúÑ ¬∑ Perfect ÌëúÏãú</small>
        </div>
      </div>

      <div class="hero">
        <!-- overall program progress -->
        <div class="progWrap">
          <div class="progTop">
            <div class="progTitle">Ï†ÑÏ≤¥ Í∏∞Í∞Ñ ÏßÑÌñâÎèÑ</div>
            <div class="progPct" id="progPct">0%</div>
          </div>

          <div class="progTrackWrap" id="progTrackWrap" aria-label="Ï†ÑÏ≤¥ Í∏∞Í∞Ñ ÏßÑÌñâ Î∞î">
            <div class="progTrack" id="progTrack">
              <div class="progFill" id="progFill"></div>
            </div>

            <div class="runner" id="runner" aria-hidden="true">
              <span class="runnerIcon">üèÉ‚Äç‚ôÇÔ∏è</span>
              <span class="runnerText" id="runnerText">Ïò§Îäò</span>
            </div>
          </div>

          <div class="progMeta">
            <span id="progStart">2025.12.14</span>
            <span id="progEnd">2026.05.02</span>
          </div>
        </div>

        <div class="heroTop">
          <div>
            <h1 id="weekTitle">Week 1</h1>
            <div class="subtitle" id="subtitle"></div>

            <div class="dataInfo">
              <div class="dataInfoText" id="dataRefText">Îç∞Ïù¥ÌÑ∞ Î∞òÏòÅ: Week 5ÍπåÏßÄ</div>
              <div class="dataBar" aria-hidden="true">
                <div class="dataBarFill" id="dataRefBar"></div>
              </div>
            </div>

            <div class="smallLine" id="rangeLine"></div>
          </div>

          <div class="controls">
            <div class="pill">
              <span>Í≤ÄÏÉâ</span>
              <input id="q" type="text" placeholder="ÌåÄÎ™Ö/ÌåÄÏõê Í≤ÄÏÉâ" />
            </div>
            <button class="btn" id="copyLink">ÌòÑÏû¨ ÏÉÅÌÉú ÎßÅÌÅ¨ Î≥µÏÇ¨</button>
          </div>
        </div>
      </div>
    </header>

    <main>
      <div class="sheet">
        <div id="board"></div>
      </div>

      <div class="hint">
        * Ï†êÏàòÎäî R(ÏùΩÍ∏∞) / Z(Ï§åÎØ∏ÌåÖ) / E(Ïù¥Î≤§Ìä∏) Ìï©Í≥ÑÎ°ú ÏûêÎèô Í≥ÑÏÇ∞Îê©ÎãàÎã§. ÎßåÏ†ê(=Rmax+Zmax+Emax)Ïùº Í≤ΩÏö∞ PerfectÍ∞Ä ÌëúÏãúÎê©ÎãàÎã§.
      </div>

      <details>
        <summary>CSVÎ°ú Îç∞Ïù¥ÌÑ∞ Î∂ôÏó¨ÎÑ£Í∏∞(ÏÑ†ÌÉù)</summary>
        <div class="hint" style="margin-top:8px;">
          Ìó§Îçî Ìè¨Ìï® CSV ÏòàÏãú: team,members,R,Z,E (membersÎäî | Î°ú Íµ¨Î∂Ñ)
        </div>
        <textarea id="csv" placeholder="team,members,R,Z,E
Íæ∏Ï§ÄÌûàÎß§ÏùºÏùΩ(1)Ï°∞,Íµ¨Ïû¨Ïó∞|ÏñëÏÜ°Îπà|Ïã†ÏùÄÏÑ≠|ÍπÄÏûêÏó∞|Ïã†Ï∞¨Ìù¨,147,10,0
JOY,ÏÜ°ÏÜîÎÇ¥|ÍπÄÏ¥àÏõê|ÏÜ°ÎØ∏ÏÜå|ÍπÄÏòàÏßÄ|Ïù¥ÏßÄÏõê,135,10,0"></textarea>
        <div class="rowSmall">
          <button class="btn" id="loadCsv">CSV Ï†ÅÏö©</button>
          <button class="btn" id="resetData">Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞Î°ú ÎêòÎèåÎ¶¨Í∏∞</button>
        </div>
      </details>
    </main>
  </div>

<script>
/** =========================
 *  0) "ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Îäî Î™á Ï£ºÍπåÏßÄ Î∞òÏòÅ?" ÌëúÏãú
 *  ========================= */
const DATA_UP_TO_WEEK = 5; // <- Ïó¨Í∏∞Îßå Î∞îÍæ∏Î©¥ Week ÏïÑÎûò Î¨∏Íµ¨/Î∞îÍ∞Ä Î∞îÎÄùÎãàÎã§.

/** =========================
 *  1) Ï†êÏàò ÎßåÏ†ê Í∏∞Ï§Ä(ÌïÑÏöî Ïãú ÏàòÏ†ï)
 *  ========================= */
const SCORE_MAX = { R: 147, Z: 10, E: 0 };
const TOTAL_MAX = SCORE_MAX.R + SCORE_MAX.Z + SCORE_MAX.E;

/** =========================
 *  2) Ï†ÑÏ≤¥ ÏÑ±Í≤ΩÏùΩÍ∏∞ Í∏∞Í∞Ñ(Í≥†Ï†ï)
 *  ========================= */
const PROGRAM_START = "2025-12-14"; // ÏùºÏöîÏùº
const PROGRAM_END   = "2026-05-02"; // ÌÜ†ÏöîÏùº

function toKSTDateOnly(yyyy_mm_dd){
  const [y,m,d] = yyyy_mm_dd.split("-").map(Number);
  return new Date(y, m-1, d);
}
function fmtKR(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}.${m}.${day}`;
}
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

function getProgramWeekInfo(today = new Date()){
  const start = toKSTDateOnly(PROGRAM_START);
  const end   = toKSTDateOnly(PROGRAM_END);
  const t = new Date(today.getFullYear(), today.getMonth(), today.getDate());

  if (t < start) return { status:"before", week:0, weekStart:null, weekEnd:null };
  if (t > end)   return { status:"after",  week:0, weekStart:null, weekEnd:null };

  const diffDays = Math.floor((t - start) / (1000*60*60*24));
  const week = Math.floor(diffDays / 7) + 1;

  const weekStart = new Date(start);
  weekStart.setDate(start.getDate() + (week-1)*7);

  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekStart.getDate() + 6);

  return { status:"in", week, weekStart, weekEnd };
}

/** =========================
 *  Ï†ÑÏ≤¥ Í∏∞Í∞Ñ ÏßÑÌñâÎ•†(ÎÇ†Ïßú Í∏∞Ï§Ä) + Îü¨ÎÑà ÏúÑÏπò (FIXED: px, clamped)
 *  ========================= */
function updateProgramProgress(today = new Date()){
  const start = toKSTDateOnly(PROGRAM_START);
  const end   = toKSTDateOnly(PROGRAM_END);
  const t = new Date(today.getFullYear(), today.getMonth(), today.getDate());

  const total = (end - start);
  const done = (t - start);

  let pct = 0;
  if (total > 0) pct = (done / total) * 100;
  pct = clamp(pct, 0, 100);

  const progFill = document.getElementById("progFill");
  const runner = document.getElementById("runner");
  const progPct = document.getElementById("progPct");
  const runnerText = document.getElementById("runnerText");
  const progStart = document.getElementById("progStart");
  const progEnd = document.getElementById("progEnd");

  const track = document.getElementById("progTrack");

  progStart.textContent = fmtKR(start);
  progEnd.textContent = fmtKR(end);

  progFill.style.width = `${pct.toFixed(1)}%`;

  // px-based runner position (prevents edge clipping)
  const w = track.getBoundingClientRect().width;
  const x = (pct / 100) * w;
  const pad = 22; // safe padding so chip won't go outside
  const clampedX = Math.max(pad, Math.min(w - pad, x));
  runner.style.left = `${clampedX}px`;

  const label =
    (t < start) ? "ÏãúÏûë Ï†Ñ" :
    (t > end) ? "ÏôÑÎ£å!" :
    "Ïò§Îäò";
  runnerText.textContent = label;

  progPct.textContent = `${pct.toFixed(1)}%`;
}

/** =========================
 *  3) Îç∞Ïù¥ÌÑ∞(Ïó¨Í∏∞Îßå Î∞îÍæ∏Î©¥ Îê©ÎãàÎã§)
 *  ========================= */
const DEFAULT_DATA = [
  { team:"Íæ∏Ï§ÄÌûàÎß§ÏùºÏùΩ(1)Ï°∞", members:["Íµ¨Ïû¨Ïó∞","ÏñëÏÜ°Îπà","Ïã†ÏùÄÏÑ≠","ÍπÄÏûêÏó∞","Ïã†Ï∞¨Ìù¨"], R:147, Z:10, E:0 },
  { team:"JOY", members:["ÏÜ°ÏÜîÎÇ¥","ÍπÄÏ¥àÏõê","ÏÜ°ÎØ∏ÏÜå","ÍπÄÏòàÏßÄ","Ïù¥ÏßÄÏõê"], R:135, Z:10, E:0 },
  { team:"ÏôÑÎèÖÌïòÏ°∞", members:["ÏûÑÎã§Ìù¨","Ìô©ÏùÄÏ†ï","ÏóÑÏ£ºÏö©","Ïù¥ÏàòÌòÑ","Î•òÏó∞Ïö∞"], R:98, Z:10, E:0 },
  { team:"Ïò§ÎäòÎèÑÏùΩÏ°∞", members:["ÏµúÌù¨ÏÑ†","ÍπÄÏßÄÎØº","ÍπÄÏú†Î¶¨","Î∞ïÎã§ÏòÅ","Ïù¥ÏòàÏ∞¨"], R:147, Z:10, E:0 },
  { team:"5ÎäòÎèÑÏôÑÎèÖ", members:["Ïú§ÌòÑÏÑù","Regan","Ï±ÑÌù¨ÎûÄ","Ï±ÑÏßÄÌòú","Ï°∞ÏùÄÏÑú"], R:135, Z:0, E:0 },
  { team:"ÌÇ¥Ïä§Ïï§Ìô©", members:["ÍπÄÏàúÌôî","Ji-Ho Kim","Ìô©Î≥¥Îùº","ÍπÄÏßÄÎØº","ÍπÄÎÇòÍ≤Ω"], R:95, Z:10, E:0 },
  { team:"ÌåÄÎ™ÖÎØ∏Ï†ï(7Ï°∞)", members:["ÏµúÏßÄÏùÄ","Ìô©ÌòÑÏ£º","Ìô©ÏßÑÍ≤Ω","Ïú†Ï†ï","Ï†ÑÌïòÏö¥"], R:98, Z:0, E:0 },
  { team:"ÌåîÏïÑÌîÑÎãàÍπåÌïÑÏÇ¨ÌïòÏßÄÎßêÍ≥†Íº¨Î∞ïÍº¨Î∞ïÏùΩÏ°∞", members:["Ïù¥ÎèÑÏó∞","Î∞ïÎèÑÌòÑ","Ïû•Ïú§Ïàò","ÍπÄÌôòÍ∑º","ÏÑ±Î™ÖÍ∑ú"], R:68, Z:10, E:0 },
  { team:"ÏûòÏùΩ9Ïã∂Ï°∞", members:["Ï°∞Í≤ΩÏú§","Î•òÎπÑÏ∑®","ÍπÄÏòàÏùÄ","ÍπÄÏßÄÏú§","ÍπÄÏú§Ìôî"], R:141, Z:10, E:0 },
  { team:"TT(Team Ten)", members:["Î∞ïÏ£ºÌòÑ","ÏÑúÏàòÏó∞","ÏµúÎØºÏàò","Ïù¥Ïû¨ÏßÑ","ÏµúÍ∞ï"], R:82, Z:0, E:0 },
  { team:"KTVM", members:["Liliana","Yami","ÏñëÏãúÏùÄ","ÍπÄÌù¨Ï†ï"], R:92, Z:10, E:0 },
  { team:"Ïó¥Ïã≠Ïù¥Ï°∞", members:["ÍπÄÏö©Îπà","Í≥†Ï±ÑÏùÄ","Ïù¥ÌòúÏßÑ","ÏÜ°Ï§ÄÎØ∏","Ï†ïÏàòÏó∞"], R:147, Z:10, E:0 },
  { team:"K5", members:["ÍπÄÌïòÏùÄ","ÍπÄÏßÄÎã¥","Ïù¥Í≤ΩÏùÄ","Í≥†ÏùÄÎπà","ÍπÄÏùÄÏÑú"], R:98, Z:10, E:0 },
];

let state = structuredClone(DEFAULT_DATA);

/** =========================
 *  Ïú†Ìã∏
 *  ========================= */
function normalize(s){ return (s ?? "").toString().trim().toLowerCase(); }
function calcTotal(t){ return (Number(t.R)||0) + (Number(t.Z)||0) + (Number(t.E)||0); }
function isPerfect(t){ return calcTotal(t) === TOTAL_MAX; }

function applyRanking(sorted){
  let rank = 0;
  let prevScore = null;
  return sorted.map(t => {
    const score = calcTotal(t);
    if (prevScore === null || score !== prevScore) rank += 1;
    prevScore = score;
    return { ...t, rank, total: score };
  });
}

function medalClass(rank){
  if (rank === 1) return "gold";
  if (rank === 2) return "silver";
  if (rank === 3) return "bronze";
  return "gray";
}
function totalRankClass(rank){
  if (rank === 1) return "rank1";
  if (rank === 2) return "rank2";
  if (rank === 3) return "rank3";
  return "";
}

function escapeHtml(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/** =========================
 *  ÏÉÅÎã® Ï£ºÏ∞® ÌÖçÏä§Ìä∏ + Îç∞Ïù¥ÌÑ∞Î∞òÏòÅ Î∞î
 *  ========================= */
function updateHeaderWeek(){
  const info = getProgramWeekInfo(new Date());
  const titleEl = document.getElementById("weekTitle");
  const subEl = document.getElementById("subtitle");
  const rangeEl = document.getElementById("rangeLine");

  const dataText = document.getElementById("dataRefText");
  const dataBar = document.getElementById("dataRefBar");

  updateProgramProgress(new Date());

  rangeEl.textContent = `Í∏∞Í∞Ñ: ${PROGRAM_START.replaceAll("-",".")} ~ ${PROGRAM_END.replaceAll("-",".")} ¬∑ ÎßåÏ†ê ${TOTAL_MAX}Ï†ê (R ${SCORE_MAX.R} / Z ${SCORE_MAX.Z} / E ${SCORE_MAX.E})`;
  dataText.textContent = `Îç∞Ïù¥ÌÑ∞ Î∞òÏòÅ: Week ${DATA_UP_TO_WEEK}ÍπåÏßÄ`;

  let pct = 100;
  if (info.status === "in" && info.week > 0){
    pct = clamp((DATA_UP_TO_WEEK / info.week) * 100, 0, 100);
  }
  dataBar.style.width = `${pct.toFixed(0)}%`;

  if (info.status === "before") {
    titleEl.textContent = "Week 0";
    subEl.textContent = `Ï†ÑÏ≤¥ ÏÑ±Í≤ΩÏùΩÍ∏∞ ¬∑ ÏãúÏûë Ï†Ñ`;
    return;
  }
  if (info.status === "after") {
    titleEl.textContent = "Completed";
    subEl.textContent = `Ï†ÑÏ≤¥ ÏÑ±Í≤ΩÏùΩÍ∏∞ ¬∑ Ï¢ÖÎ£å`;
    return;
  }
  titleEl.textContent = `Week ${info.week}`;
  subEl.textContent = `Ï†ÑÏ≤¥ ÏÑ±Í≤ΩÏùΩÍ∏∞ ¬∑ ${info.week}Ï£ºÏ∞® (${fmtKR(info.weekStart)} ~ ${fmtKR(info.weekEnd)})`;
}

/** =========================
 *  Î†åÎçî
 *  ========================= */
function render(){
  updateHeaderWeek();

  const q = normalize(document.getElementById("q").value);
  const filtered = state.filter(t => {
    if (!q) return true;
    const hay = normalize(t.team) + " " + normalize(t.members.join(" "));
    return hay.includes(q);
  });

  const sorted = [...filtered].sort((a,b)=>{
    const ta = calcTotal(a), tb = calcTotal(b);
    if (tb !== ta) return tb - ta;
    return a.team.localeCompare(b.team, "ko");
  });

  const ranked = applyRanking(sorted);

  const board = document.getElementById("board");
  board.innerHTML = ranked.map(t => {
    const perfect = isPerfect(t);
    const pct = TOTAL_MAX ? clamp((t.total / TOTAL_MAX) * 100, 0, 100) : 0;

    const topClass = (t.rank === 1) ? "top1" : (t.rank === 2) ? "top2" : (t.rank === 3) ? "top3" : "";
    const isTop3 = t.rank <= 3;

    return `
      <div class="row ${topClass}">
        <div class="leftBlock">
          <div class="rankBadge ${medalClass(t.rank)} ${isTop3 ? "top3d" : ""}">${t.rank}</div>
          <div class="teamBlock">
            <div class="team">${escapeHtml(t.team)}</div>
            <div class="members">${escapeHtml(t.members.join(", "))}</div>
          </div>
        </div>

        <div class="right">
          <div class="rightTop">
            ${perfect ? `<span class="perfectTag">Perfect</span>` : ``}
          </div>

          <div class="meta">
            <div class="labels">R&nbsp;&nbsp;Z&nbsp;&nbsp;E</div>
            <div class="numbersLine">${Number(t.R)||0}&nbsp;&nbsp;${Number(t.Z)||0}&nbsp;&nbsp;${Number(t.E)||0}</div>
          </div>

          <div class="total ${totalRankClass(t.rank)}">${t.total}</div>
        </div>

        <div class="progressTrack">
          <div class="progressFill" style="width:${pct.toFixed(1)}%"></div>
        </div>
      </div>
    `;
  }).join("") || `<div style="padding:14px; color:#667085; font-family:Pretendard, system-ui, sans-serif;">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>`;
}

/** =========================
 *  ÎßÅÌÅ¨ Í≥µÏú†(ÏøºÎ¶¨Ïä§Ìä∏ÎßÅÏóê ÏÉÅÌÉú Ï†ÄÏû•)
 *  ========================= */
function encodeStateToUrl(){
  const payload = state.map(t => ({
    team: t.team,
    members: t.members,
    R: Number(t.R)||0,
    Z: Number(t.Z)||0,
    E: Number(t.E)||0
  }));
  const json = JSON.stringify(payload);
  const b64 = btoa(unescape(encodeURIComponent(json)));
  const url = new URL(location.href);
  url.searchParams.set("data", b64);
  return url.toString();
}

function decodeStateFromUrl(){
  const url = new URL(location.href);
  const b64 = url.searchParams.get("data");
  if (!b64) return false;
  try{
    const json = decodeURIComponent(escape(atob(b64)));
    const arr = JSON.parse(json);
    if (!Array.isArray(arr)) return false;
    state = arr.map(x => ({
      team: x.team ?? "",
      members: Array.isArray(x.members) ? x.members : [],
      R: Number(x.R)||0,
      Z: Number(x.Z)||0,
      E: Number(x.E)||0
    }));
    return true;
  }catch(e){
    console.warn("Failed to load data from URL:", e);
    return false;
  }
}

/** =========================
 *  CSV Î°úÎçî
 *  ========================= */
function parseCsv(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if (lines.length < 2) return null;

  const header = lines[0].split(",").map(h=>h.trim());
  const idx = {
    team: header.findIndex(h=>normalize(h)==="team"),
    members: header.findIndex(h=>normalize(h)==="members"),
    R: header.findIndex(h=>normalize(h)==="r"),
    Z: header.findIndex(h=>normalize(h)==="z"),
    E: header.findIndex(h=>normalize(h)==="e"),
  };
  if (idx.team < 0) return null;

  const out = [];
  for (let i=1;i<lines.length;i++){
    const cols = lines[i].split(",");
    const team = (cols[idx.team] ?? "").trim();
    if (!team) continue;

    const membersRaw = (idx.members>=0 ? (cols[idx.members] ?? "") : "").trim();
    const members = membersRaw ? membersRaw.split("|").map(s=>s.trim()).filter(Boolean) : [];

    out.push({
      team,
      members,
      R: Number(cols[idx.R] ?? 0) || 0,
      Z: Number(cols[idx.Z] ?? 0) || 0,
      E: Number(cols[idx.E] ?? 0) || 0
    });
  }
  return out;
}

/** =========================
 *  Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
 *  ========================= */
document.getElementById("q").addEventListener("input", render);

document.getElementById("copyLink").addEventListener("click", async ()=>{
  try{
    const link = encodeStateToUrl();
    await navigator.clipboard.writeText(link);
    alert("ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Í∞Ä Ìè¨Ìï®Îêú ÎßÅÌÅ¨Î•º Î≥µÏÇ¨ÌñàÏäµÎãàÎã§.");
  }catch(e){
    alert("Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. (Î∏åÎùºÏö∞Ï†Ä Í∂åÌïúÏùÑ ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî)");
  }
});

document.getElementById("loadCsv").addEventListener("click", ()=>{
  const text = document.getElementById("csv").value;
  const parsed = parseCsv(text);
  if (!parsed){
    alert("CSV ÌòïÏãùÏùÑ ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî. (Ìó§Îçî Ìè¨Ìï®: team,members,R,Z,E / membersÎäî | Î°ú Íµ¨Î∂Ñ)");
    return;
  }
  state = parsed;
  render();
});

document.getElementById("resetData").addEventListener("click", ()=>{
  state = structuredClone(DEFAULT_DATA);
  const url = new URL(location.href);
  url.searchParams.delete("data");
  history.replaceState({}, "", url.toString());
  render();
});

// IMPORTANT: keep runner correct on resize
window.addEventListener("resize", () => updateHeaderWeek());

/** =========================
 *  Ï¥àÍ∏∞ Î°úÎî©
 *  ========================= */
decodeStateFromUrl();
render();
</script>
</body>
</html>
